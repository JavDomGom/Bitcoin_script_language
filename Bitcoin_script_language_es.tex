\documentclass{article}
\usepackage[spanish]{babel}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{minted}
\usepackage{courier}
\usepackage[dvipsnames]{xcolor}
\usepackage{relsize}
\usepackage{amsmath}
\usepackage{titlesec}

\setcounter{secnumdepth}{4}
\titleformat{\paragraph}
{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\definecolor{red}{rgb}{0.95,0.12,0.14}
\definecolor{green}{rgb}{0.47,0.58,0.17}
\definecolor{darkTurquoise}{rgb}{0.18,0.65,0.74}
\definecolor{blue}{rgb}{0.16,0,0.98}
\definecolor{purple}{rgb}{0.65,0.03,0.69}

\title{\textbf{Bitcoin Script language}}
\author{Javier Domínguez Gómez \\
\small{jdg@member.fsf.org} \\
\small{Fingerprint: 94AD 19F4 9005 EEB2 3384 C20F 5BDC C668 D664 8E2B}}
\date{v0.1.00 - Mayo 2019}

\begin{document}
\maketitle

\tableofcontents{}

\vspace{19mm}

\section{Introducción}

\section{Datos de un bloque}
\begin{figure}[H]
\scriptsize{\texttt{$\sim$/.bitcoin/blocks/\$ hexdump\ -C\ -s\ 93725126\ -n\ 288\ blk00116.dat}}
    
    \scriptsize{
    \texttt{059621c6  \textbf{\textcolor{red}{f9 be b4 d9} \textcolor{green}{bd 53 02 00}  \textcolor{darkTurquoise}{02 00 00 00 17 97 5b 97}}  |.....S........[.|} \\
    \texttt{059621d6  \textbf{\textcolor{darkTurquoise}{c1 8e d1 f7 e2 55 ad f2  97 59 9b 55 33 0e da b8}}  |.....U...Y.U3...|} \\
    \texttt{059621e6  \textbf{\textcolor{darkTurquoise}{78 03 c8 17 01 00 00 00  00 00 00 00 8a 97 29 5a}}  |x.............)Z|} \\
    \texttt{059621f6  \textbf{\textcolor{darkTurquoise}{27 47 b4 f1 a0 b3 94 8d  f3 99 03 44 c0 e1 9f a6}}  |'G.........D....|} \\
    \texttt{05962206  \textbf{\textcolor{darkTurquoise}{b2 b9 2b 3a 19 c8 e6 ba  dc 14 17 87 35 8b 05 53}}  |..+:........5..S|} \\
    \texttt{05962216  \textbf{\textcolor{darkTurquoise}{53 5f 01 19 48 75 08 33}  \textcolor{blue}{63} \textcolor{purple}{01 00 00 00 01 00 00}}  |S\_..Hu.3c.......|} \\
    \texttt{05962226  \textbf{\textcolor{purple}{00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00}}  |................|} \\
    \texttt{05962236  \textbf{\textcolor{purple}{00 00 00 00 00 00 00 00  00 00 00 00 00 00 ff ff}}  |................|} \\
    \texttt{05962246  \textbf{\textcolor{purple}{ff ff 60 03 63 60 04 06  2f 50 32 53 48 2f 04 35}}  |..`.c`../P2SH/.5|} \\
    \texttt{05962256  \textbf{\textcolor{purple}{8b 05 53 08 44 04 f2 53  00 00 17 e4 46 52 2c fa}}  |..S.D..S....FR,.|} \\
    \texttt{05962266  \textbf{\textcolor{purple}{be 6d 6d 69 06 88 fb 88  6c 0d f0 c8 7c bc 7e a4}}  |.mmi....l...|.~.|} \\
    \texttt{05962276  \textbf{\textcolor{purple}{f7 f1 b5 c0 05 0b d0 ac  37 51 cf c9 97 d9 d6 97}}  |........7Q......|} \\
    \texttt{05962286  \textbf{\textcolor{purple}{13 28 de 04 00 00 00 00  00 00 00 48 61 70 70 79}}  |.(.........Happy|} \\
    \texttt{05962296  \textbf{\textcolor{purple}{20 4e 59 21 20 59 6f 75  72 73 20 47 48 61 73 68}}  | NY! Yours GHash|} \\
    \texttt{059622a6  \textbf{\textcolor{purple}{2e 49 4f 00 00 00 00 01  cb 81 31 95 00 00 00 00}}  |.IO.......1.....|} \\
    \texttt{059622b6  \textbf{\textcolor{purple}{19 76 a9 14 80 ad 90 d4  03 58 1f a3 bf 46 08 6a}}  |.v.......X...F.j|} \\
    \texttt{059622c6  \textbf{\textcolor{purple}{91 b2 d9 d4 12 5d b6 c1  88 ac 00 00 00 00 01 00}}  |.....]..........|} \\
    \texttt{059622d6  \textbf{\textcolor{purple}{00 00 01 7d 67 7c de 17  3f 8c bf 43 31 27 a8 5e}}  |...\}g|..?..C1'.\textasciicircum|
    \texttt{059622e6} ...}
    }
    \end{figure}

\section{Transacción \textit{Coinbase}}
154 bytes más adelante.
\begin{figure}[H]
\scriptsize{\texttt{$\sim$/.bitcoin/blocks/\$ hexdump\ -C\ -s\ 93725215\ -n\ 154\ blk00116.dat}}
    
    \scriptsize{
    \texttt{0596221f  \textbf{\textcolor{purple}{01 00 00 00 01 00 00 00  00 00 00 00 00 00 00 00}}  |................|} \\
    \texttt{0596222f  \textbf{\textcolor{purple}{00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00}}  |................|} \\
    \texttt{0596223f  \textbf{\textcolor{purple}{00 00 00 00 00 ff ff ff  ff 60 03 63 60 04 06 2f}}  |.........`.c`../|} \\
    \texttt{0596224f  \textbf{\textcolor{purple}{50 32 53 48 2f 04 35 8b  05 53 08 44 04 f2 53 00}}  |P2SH/.5..S.D..S.|} \\
    \texttt{0596225f  \textbf{\textcolor{purple}{00 17 e4 46 52 2c fa be  6d 6d 69 06 88 fb 88 6c}}  |...FR,..mmi....l|} \\
    \texttt{0596226f  \textbf{\textcolor{purple}{0d f0 c8 7c bc 7e a4 f7  f1 b5 c0 05 0b d0 ac 37}}  |...|.~.........7|} \\
    \texttt{0596227f  \textbf{\textcolor{purple}{51 cf c9 97 d9 d6 97 13  28 de 04 00 00 00 00 00}}  |Q.......(.......|} \\
    \texttt{0596228f  \textbf{\textcolor{purple}{00 00 48 61 70 70 79 20  4e 59 21 20 59 6f 75 72}}  |..Happy NY! Your|} \\
    \texttt{0596229f  \textbf{\textcolor{purple}{73 20 47 48 61 73 68 2e  49 4f 00 00 00 00 01 cb}}  |s GHash.IO......|} \\
    \texttt{059622af  \textbf{\textcolor{purple}{81 31 95 00 00 00 00 19  76 a9 \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }}  |.1......v.|} \\
    \texttt{059622de} ...}
\end{figure}

    \subsubsection{Versión}
    Es el número de versión para el registro de las transacciones, se trata de un número entero con una longitud de 4 \textit{bytes} en formato \textit{Little-Endian} que actualmente tiene un valor hexadecimal de \texttt{0x01000000} o 1 en base decimal.
    \begin{figure}[H]
        \texttt{0x01000000}
    \end{figure}
    
    \subsubsection{Input count}
    Esta variable es un tiene por valor un número entero positivo de longitud variable, desde 1 hasta 9 \textit{bytes}, y representa el número de entradas o \textit{inputs} que tiene la transacción.
    \begin{figure}[H]
        \texttt{0x01}
    \end{figure}
    
    \subsubsection{Input}
    
    \paragraph{TXID}
    Se trata del un número identificativo o \textit{id} de 32 bytes que representa la transacción en el bloque. Una de las características que diferencia a una transacción de tipo \textit{Coinbase} del resto es que en las transacciones \textit{Coinbase} el valor de TXID es un numero hexadecimal con valor cero.
    \begin{figure}[H]
        \texttt{0x0000000000000000000000000000000} \\
        \texttt{000000000000000000000000000000000}
    \end{figure}
    En una transacción corriente este dato se obtiene aplicando la función hash SHA-256 dos veces a los datos de la transacción en formato \textit{Little-Endian}.
    
    \paragraph{VOUT}
    En Bitcoin todas las salidas u \textit{outputs} de una transacción se almacenan en un dato de tipo vector. VOUT es un número hexadecimal con una longitud de 4 bytes que representa el índice de las salidas u \textit{outputs} de una transacción en dicho vector. Otra de las características de una transacción de tipo \textit{Coinbase} es que el valor para VOUT es siempre \texttt{0xffffffff}, el número de 4 bytes de más alto valor.
    \begin{figure}[H]
        \texttt{0xffffffff}
    \end{figure}
    
    \paragraph{scriptSig size}
    Esta variable es un tiene por valor un número hexadecimal de longitud variable, desde 1 hasta 9 \textit{bytes} que representa el tamaño en \textit{bytes} que tendrán los datos almacenados en \textit{scriptSig}.
    \begin{figure}[H]
        \texttt{0x60}
    \end{figure}
    En este caso el tamaño es de \texttt{0x60}, que tras convertirlo a base decimal son 96 bytes. Para este dato existe límite de tamaño que actualmente es de 1650 \textit{bytes}.
    
    \paragraph{scriptSig}
    Se trata de un dato de de longitud variable, en este caso tiene una longitud de 96 bytes pero podría contener más o menos información. A menudo lo utilizan los mineros para incluir mensajes de texto personalizados empleando caracteres ASCII, normalmente el nombre del minero o del pool de minería que ha resuelto el el hash válido para poder minar el bloque.
    \begin{figure}[H]
        \texttt{0x03636004062f503253482f04358b0553084404f253000017e446522c} \\
        \texttt{fabe6d6d690688fb886c0df0c87cbc7ea4f7f1b5c0050bd0ac3751cfc9}
        \texttt{97d9d6971328de04000000000000004861707079204e592120596f7572}
        \texttt{732047486173682e494f}
    \end{figure}
    
    En este caso contiene el siguiente mensaje ASCII:
    \begin{figure}[H]
    \centering
        \texttt{`.c`../P2SH/.5..S.D..S....FR,..mmi....l...|.\textasciicircum....}
        \texttt{......7Q.......(.........Happy NY! Yours GHash.IO}
    \end{figure}
    
    Para evitar que varias transacciones de tipo \textit{Coinbase} pertenecientes a diferentes bloques tengan el mismo valor en TXID se decidió implementar mediante la propuesta BIP34\footnote{https://github.com/bitcoin/bips/blob/master/bip-0034.mediawiki} un sistema que añade al inicio del valor de \textit{scriptSig} un bloque de 4 bytes, dividido en dos secciones:
    
    \begin{itemize}
    \item La primera es una constante\footnote{https://en.bitcoin.it/wiki/Script\#Constants} de 1 \textit{byte} de longitud que representa un OP\_CODE, en este caso el valor \texttt{0x03} indica que el siguiente OP\_CODE contiene datos que se han de colocar en la pila.
    \item La segunda sección es un dato de 3 bytes en formato \textit{Little-Endian} que representan la altura o el número del bloque al que pertenece la transacción \textit{Coinbase}, en este caso \texttt{0x636004}.
    \end{itemize}
    
    La transacción \textit{Coinbase} que se ha utilizado en este ejemplo pertenece al bloque número \texttt{\#}286819 de la cadena de bloques de \textit{Bitcoin} en la red principal \textit{mainnet}. Si se convierten los 3 bytes \texttt{0x636004} a formato \textit{Big-Endian} se obtiene el valor hexadecimal \texttt{0x046063}, que en base 10 o decimal es el número 286819 y se corresponde con el número de bloque al que pertenece esta transacción.
    
    \paragraph{Sequence}
    Se trata de un número de 4 bytes de longitud, se utiliza para permitir que las transacciones no confirmadas que tengan un \textit{Locktime} se actualicen antes de darlas por finalizadas o confirmadas. También se utiliza para desactivar el \textit{Locktime} de la transacción.
    \begin{figure}[H]
        \texttt{0x00000048}
    \end{figure}
    
    \subsubsection{Output count}
    \begin{figure}[H]
        \texttt{0x61}
    \end{figure}
    
    \subsubsection{Output (Value)}
    \begin{figure}[H]
        \texttt{0x707079204e592120}
    \end{figure}
    
    \subsubsection{Output (scriptPubKey size)}
    \begin{figure}[H]
        \texttt{0x1f}
    \end{figure}
    
    \subsubsection{Output (scriptPubKey)}
    \begin{figure}[H]
        \texttt{0x596f7572732047486173682e494f0000000001cb813195000000}
    \end{figure}
    
    \subsubsection{Locktime}
    \begin{figure}[H]
        \texttt{0x001976a9}
    \end{figure}
    
\end{document}
